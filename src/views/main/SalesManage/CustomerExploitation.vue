<template>
    <div>
        <div style="box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);padding-left: 1rem;">
            <el-descriptions title="客户开发计划">
                <el-descriptions-item label="制定客户开发计划和记录开发进度"></el-descriptions-item>
            </el-descriptions>
        </div>
        <div class="padding-box" style="box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1)">
            <vxe-grid ref='xGrid' v-bind="gridOptions" style="margin-left: 20px;
    margin-right: 20px;">
                <template #name_item="{ data }">
                    <vxe-input v-model="data.chcCustName" type="text" placeholder="请输入客户名称"></vxe-input>
                </template>
                <template #contact_item="{ data }">
                    <vxe-input v-model="data.chcLinkman" type="text" placeholder="请输入联系人名称"></vxe-input>
                </template>
                <template #briefly_item="{ data }">
                    <vxe-input v-model="data.chcTitle" type="text" placeholder="请输入概要"></vxe-input>
                </template>
                <template #status_item="{ data }">
                    <el-select v-model="data.chcStatus" class="m-2" placeholder="全部">
                        <el-option v-for="item in type" :label="item.lable" :value="item.value" />
                    </el-select>
                </template>
                <template #submit_item>
                    <vxe-button type="submit" status="primary" content="查询"></vxe-button>
                </template>
                <template #operate="{ row }">
                    <div v-if="row.chcStatus === 2">
                        <vxe-button status="primary" size="mini" content="制订" round @click="toModal(row, 2)">
                        </vxe-button>
                        <vxe-button status="warning" size="mini" content="执行" round @click="toModal(row, 3)">
                        </vxe-button>
                        <el-popconfirm title="确定计划已成功?" confirm-button-text="确认" cancel-button-text="取消"
                            @confirm="editPlanStatus(row.chcId, 3)">
                            <template #reference>
                                <vxe-button status="success" size="mini" content="成功" round></vxe-button>
                            </template>
                        </el-popconfirm>
                        <el-popconfirm title="确定要终止吗?" confirm-button-text="确认" cancel-button-text="取消"
                            @confirm="editPlanStatus(row.chcId, 4)">
                            <template #reference>
                                <vxe-button status="danger" size="mini" content="终止" round></vxe-button>
                            </template>
                        </el-popconfirm>
                    </div>
                    <div v-else>
                        <vxe-button status="success" size="mini" content="查看" round @click="toModal(row, 1)">
                        </vxe-button>
                        <vxe-modal v-model="modalStatus" :draggable="false" width="60%" title="客户信息">
                            <template #default>
                                <vxe-form :data="editForm" title-align="right" custom-layout>
                                    <vxe-form-item title="客户名称:" field="chcCustName" :span=8>
                                        <template #default>
                                            <vxe-input v-model="editForm.chcCustName" placeholder="请输入客户名称"
                                                :disabled=inputDisable.checkInput clearable>
                                            </vxe-input>
                                        </template>
                                    </vxe-form-item>
                                    <vxe-form-item title="机会来源:" field="chcSource" :span=8>
                                        <template #default>
                                            <vxe-input v-model="editForm.chcSource" placeholder="请输入机会来源"
                                                :disabled=inputDisable.checkInput clearable>
                                            </vxe-input>
                                        </template>
                                    </vxe-form-item>
                                    <vxe-form-item title="成功几率:" field="chcRate" :span=8>
                                        <template #default>
                                            <vxe-input v-model="editForm.chcRate" placeholder="请输入成功几率"
                                                :disabled=inputDisable.checkInput clearable>
                                            </vxe-input>
                                        </template>
                                    </vxe-form-item>
                                    <vxe-form-item title="联系人:" field="chcLinkman" :span=8>
                                        <template #default>
                                            <vxe-input v-model="editForm.chcLinkman" placeholder="请输入联系人名称"
                                                :disabled=inputDisable.checkInput clearable>
                                            </vxe-input>
                                        </template>
                                    </vxe-form-item>
                                    <vxe-form-item title="联系电话:" field="chcTel" :span=8>
                                        <template #default>
                                            <vxe-input v-model="editForm.chcTel" placeholder="请输入联系人电话"
                                                :disabled=inputDisable.checkInput clearable>
                                            </vxe-input>
                                        </template>
                                    </vxe-form-item>
                                    <vxe-form-item title="概要:" field="chcTitle" :span=8>
                                        <template #default>
                                            <vxe-input v-model="editForm.chcTitle" placeholder="请输入概要"
                                                :disabled=inputDisable.checkInput clearable>
                                            </vxe-input>
                                        </template>
                                    </vxe-form-item>
                                    <vxe-form-item title="机会描述:" field="chcDesc" :span=8>
                                        <template #default>
                                            <vxe-input v-model="editForm.chcDesc" placeholder="请输入机会描述"
                                                :disabled=inputDisable.checkInput>
                                            </vxe-input>
                                        </template>
                                    </vxe-form-item>
                                    <vxe-form-item title="创建人:" field="chcCreateBy" :span=8>
                                        <template #default>
                                            <vxe-input v-model="editForm.chcCreateBy" placeholder="请输入创建人"
                                                :disabled=inputDisable.checkInput clearable>
                                            </vxe-input>
                                        </template>
                                    </vxe-form-item>
                                    <vxe-form-item title="创建时间:" field="chcCreateDate" :span=8>
                                        <template #default>
                                            <el-date-picker v-model="editForm.chcCreateDate" type="date"
                                                placeholder="请选择创建日期" value-format="YYYY-MM-DD"
                                                :disabled=inputDisable.checkInput />
                                        </template>
                                    </vxe-form-item>
                                    <vxe-form-item title="指派人:" field="chcDueTo" :span=8>
                                        <template #default>
                                            <vxe-input v-model="editForm.chcDueTo" placeholder="请输入指派人"
                                                :disabled=inputDisable.checkInput clearable>
                                            </vxe-input>
                                        </template>
                                    </vxe-form-item>
                                    <vxe-form-item title="指派时间:" field="chcDueDate">
                                        <template #default>
                                            <el-date-picker v-model="editForm.chcDueDate" type="date"
                                                placeholder="请选择指派时间" value-format="YYYY-MM-DD"
                                                :disabled=inputDisable.checkInput />
                                        </template>
                                    </vxe-form-item>
                                </vxe-form>
                                <vxe-table border show-header-overflow show-overflow="tooltip"
                                    :row-config="{ isHover: true }" :data="planData"
                                    :edit-config="{ trigger: 'click', mode: 'cell' }">
                                    <vxe-column field="plaId" :visible="false"></vxe-column>
                                    <vxe-column field="plaDate" title="日期"></vxe-column>
                                    <vxe-column field="plaTodo" title="计划" :edit-render="{}">
                                        <template #edit="{ row }">
                                            <vxe-input v-model="row.plaTodo" type="text"
                                                :disabled=inputDisable.makeInput>
                                            </vxe-input>
                                        </template>
                                    </vxe-column>
                                    <vxe-column field="plaResult" title="执行效果" v-if="inputDisable.colum"
                                        :edit-render="{}">
                                        <template #edit="{ row }">
                                            <vxe-input v-model="row.plaResult" type="text"
                                                :disabled=inputDisable.delete>
                                            </vxe-input>
                                        </template>
                                    </vxe-column>
                                    <template v-if="inputDisable.operate">
                                        <vxe-column title="操作">
                                            <template #default="{ row }">
                                                <vxe-button status="success" size="mini" content="保存"
                                                    @click="saveEdit(row)" round>
                                                </vxe-button>
                                                <vxe-button status="danger" size="mini" content="删除" round
                                                    v-if="inputDisable.delete" @click="delPlanById(row)">
                                                </vxe-button>
                                            </template>
                                        </vxe-column>
                                    </template>
                                </vxe-table>
                                <el-card class="box-card" v-if="inputDisable.form" style="margin-top: 2rem;">
                                    <template #header>
                                        <div class="card-header">
                                            <span>新建计划</span>
                                        </div>
                                    </template>
                                    <vxe-form :data="editForm">
                                        <vxe-form-item title="日期" :span="8">
                                            <template #default>
                                                <el-date-picker v-model="editForm.plaDate" type="date"
                                                    placeholder="请选择日期" value-format="YYYY-MM-DD" />
                                            </template>
                                        </vxe-form-item>
                                        <vxe-form-item title="计划项" :span="14">
                                            <template #default>
                                                <vxe-input v-model="editForm.plaTodo" placeholder="请输入计划项"></vxe-input>
                                            </template>
                                        </vxe-form-item>
                                        <vxe-form-item>
                                            <template #default :span="2">
                                                <vxe-button type="submit" status="primary" content="新建"
                                                    @click="addPlanForm()">
                                                </vxe-button>
                                            </template>
                                        </vxe-form-item>
                                    </vxe-form>
                                </el-card>
                            </template>
                        </vxe-modal>
                    </div>
                </template>
            </vxe-grid>
        </div>
    </div>
</template>

<script setup lang="ts">
import { reactive, ref } from 'vue';
import { VxeGridProps, VxeGridInstance } from 'vxe-table'
import { planByLike, editStatus, getPlanByChcId, editPlan, delPlan, addPlan } from '@/api/plan';
import { ElMessage } from 'element-plus'

var inputDisable = reactive({
    checkInput: true,
    makeInput: true,
    colum: false,
    operate: false,
    delete: false,
    form: false
})
var modalStatus = ref(false)
const type = reactive([
    { value: 0, lable: "全部" },
    { value: 2, lable: "开发中" },
    { value: 3, lable: "开发成功" },
    { value: 4, lable: "开发失败" }
])
var planData = ref([
])
var editForm = reactive({
    chcCustName: '',
    chcSource: '',
    chcRate: '',
    chcLinkman: '',
    chcTel: '',
    chcTitle: '',
    chcDesc: '',
    chcCreateBy: '',
    chcCreateDate: '',
    chcId: '',
    chcDueTo: '',
    chcDueDate: '',
    plaDate: "",
    plaTodo: ""
})
const xGrid = ref<VxeGridInstance>()
const gridOptions = reactive<VxeGridProps>({
    border: true,
    showOverflow: 'tooltip',
    height: 530,
    rowConfig: {
        keyField: 'chcId',
        isHover: true
    },
    columnConfig: {
        resizable: true
    },
    checkboxConfig: {
        reserve: true
    },
    pagerConfig: {
        pageSize: 10
    },
    formConfig: {
        items: [
            { field: 'chcCustName', title: '客户名称', itemRender: {}, slots: { default: 'name_item' } },
            { field: 'chcLinkman', title: '联系人名称', itemRender: {}, slots: { default: 'contact_item' } },
            { field: 'chcTitle', title: '概要', itemRender: {}, slots: { default: 'briefly_item' } },
            { field: 'chcStatus', title: '开发状态', itemRender: {}, slots: { default: 'status_item' } },
            { itemRender: {}, slots: { default: 'submit_item' } },
        ]
    },
    columns: [
        { field: 'chcCustName', title: '客户名称' },
        { field: 'chcTitle', title: '概要' },
        { field: 'chcLinkman', title: '联系人' },
        { field: 'chcTel', title: '联系电话' },
        { field: 'chcCreateDate', title: '创建时间' },
        {
            field: 'chcStatus', title: '状态', formatter({ cellValue }) {
                let typrFomatter = ''
                if (cellValue == 2) {
                    typrFomatter = "开发中"
                } else if (cellValue == 3) {
                    typrFomatter = "开发成功"
                } else {
                    typrFomatter = "开发失败"
                }
                return typrFomatter
            }
        },
        { title: '操作', width: 270, slots: { default: 'operate' } }
    ],
    proxyConfig: {
        form: true,
        seq: true, // 启用动态序号代理（分页之后索引自动计算为当前页的起始序号）
        props: {
            result: 'result',
            total: 'page.total'
        },
        ajax: {
            // 接收 Promise
            query: ({ page, form }) => {
                return new Promise(resolve => {
                    setTimeout(() => {
                        var list: any[] = [];
                        planByLike(form).then((res: any[]) => {
                            list = res
                            resolve({
                                page: {
                                    total: list.length
                                },
                                result: list.slice((page.currentPage - 1) * page.pageSize, page.currentPage * page.pageSize)
                            })
                        })
                    }, 1000)
                })
            }
        }
    }
})

const toModal = async (row: any, id: number) => {
    Object.keys(editForm).forEach(key => editForm[key] = '')
    editForm.chcCustName = row.chcCustName
    editForm.chcSource = row.chcSource
    editForm.chcRate = row.chcRate
    editForm.chcLinkman = row.chcLinkman.trim()
    editForm.chcTel = row.chcTel
    editForm.chcTitle = row.chcTitle
    editForm.chcDesc = row.chcDesc
    editForm.chcCreateBy = row.chcCreateBy
    editForm.chcCreateDate = row.chcCreateDate
    editForm.chcId = row.chcId
    editForm.chcDueTo = row.chcDueTo
    editForm.chcDueDate = row.chcDueDate
    getPlanByChcId(row.chcId).then((result) => {
        planData.value = result
    })
    if (id == 2) {
        inputDisable.form = true
        inputDisable.delete = true
        inputDisable.colum = false
        inputDisable.makeInput = false
        inputDisable.operate = true
    } else if (id == 1) {
        inputDisable.form = false
        inputDisable.delete = true
        inputDisable.operate = false
        inputDisable.makeInput = true
        inputDisable.colum = true
    } else if (id == 3) {
        Object.keys(inputDisable).forEach(key => inputDisable[key] = true)
        inputDisable.form = false
        inputDisable.delete = false
    }
    modalStatus.value = true
}
const editPlanStatus = async (chcId: number, chcStatus: number) => {
    editStatus(chcId, chcStatus).then((result: any) => {
        if (result == "修改成功") {
            ElMessage({
                message: result,
                type: 'success',
            })
            xGrid.value?.commitProxy('query')
        } else {
            ElMessage.error(result)
        }
    })
}
const saveEdit = async (row) => {
    if (row.plaTodo.trim() == '' && row.plaResult.trim() == '') {
        ElMessage.error("内容不能为空")
    } else {
        editPlan(row).then((result: any) => {
            if (result == "保存成功") {
                ElMessage({
                    message: result,
                    type: 'success',
                })
                xGrid.value?.commitProxy('query')
            } else {
                ElMessage.error(result)
            }
        })
    }
}
const addPlanForm = async () => {
    addPlan(editForm.plaDate, editForm.plaTodo, Number(editForm.chcId)).then((result: any) => {
        if (result == "新建成功") {
            ElMessage({
                message: result,
                type: 'success',
            })
            xGrid.value?.commitProxy('query')
        } else {
            ElMessage.error(result)
        }
    })
}
const delPlanById = async (row) => {
    delPlan(row.plaId).then((result: any) => {
        if (result == "删除成功") {
            ElMessage({
                message: result,
                type: 'success',
            })
            xGrid.value?.commitProxy('query')
        } else {
            ElMessage.error(result)
        }
    })
}
</script>

<style lang="css" scoped>
.padding-box {
    padding-top: 20px;
    margin-top: 20px;
}

.size--mini {
    margin-left: 10px;
}
</style>